# Getting Started

<!-- Please read our [CONTRIBUTING.md](CONTRIBUTING.md) which outlines all of our policies, procedures, and requirements for contributing to this project. -->

1. Make sure your [development environment](https://dev.azure.com/msazuredev/AzureForOperatorsIndustry/_wiki/wikis/AzureForOperatorsIndustry.wiki/684/WSL2-based-development-environment) is in line with this wiki article.

2. Clone the repository locally.

    ```bash
    git clone git@ssh.dev.azure.com:v3/msazuredev/AzureForOperatorsIndustry/afoi-nfa-api
    git submodule update --init --recursive
    ```

3. Configure credential to Azure DevOps data feed for our project `AzureForOperatorsIndustry`.

    The API specification generation uses `npm` and requires first a manual setup of the credentials to connect to our project data feed.

    - Open Data Feed and follow the instructions for [npm connect](https://dev.azure.com/msazuredev/AzureForOperatorsIndustry/_artifacts/feed/AzureForOperatorsIndustry_PublicPackages/connect/npm).
    - Choose Other tab.
    - `afoi-nfa-api/.npmrc` file is already configured so you can skip that.
    - Your credentials will reside in the `~/.npmrc` file. If the file already exists, replace the content as described in Step 1.
    - Follow the Step 1 through 4.

4. Install development dependencies.

    This repo relies on the set of tools, such as:
    - node.js
    - npm
    - autorest npm package and its dependencies

    If this is the first time you are working with the repository, you can install the necessary tools using:

    ```bash
    make setup-env
    ```

    If you see issues with npm errors `npm ERR! code ERR_TLS_CERT_ALTNAME_INVALID, npm ERR! errno ERR_TLS_CERT_ALTNAME_INVALID` run the following:

    ```bash
    az artifacts universal download --organization "https://dev.azure.com/msazuredev/" --project "c0b6323e-5225-48c2-85df-819f77430aea" --scope project --feed "NetworkCloudAutorestNonsense" --name "autorest-nonsense" --version "0.0.1" --path .
    tar xfz autorest.tgz -C ~
    make install-swagger-ci
    ```

    If you want to refresh the swagger CI tools only, you can execute:

    ```bash
    make install-swagger-ci
    ```

    The above command will add the missing Python dependencies (that are broken in autorest).

    If you are interested in refreshing the npm packages only, execute:

    ```bash
    npm ci
    ```

## NPM troubleshooting

If you are getting 401 while running `npm ci`, please try these steps:

- Remove the old configuration and reinstall

    ```sh
    sudo apt-get remove -y nodejs npm
    rm -rf ~/.npm
    make install-swagger-ci
    ```

- Regenerate PAT token using the setup instructions.

# Generation of python wheel
- Make sure above steps are done. 
- Run the following commands
    ```
    make generate-cli
    make install-cli
    ```
This will generate the `python wheel` and install it. Now you can access the `az commands`

# What are 'manual' and 'custom-cli' folders? 
## manual
- manual folder location : [manual](https://dev.azure.com/msazuredev/AzureForOperatorsIndustry/_git/afoi-nfa-api?path=/cli/2023-02-01-preview/src/ManagedNetworkFabric/azext_ManagedNetworkFabric/manual)
- Autogenerated python files from [generated](https://dev.azure.com/msazuredev/AzureForOperatorsIndustry/_git/afoi-nfa-api?path=/cli/2023-02-01-preview/src/ManagedNetworkFabric/azext_ManagedNetworkFabric/generated) folder will be updated in manual folder

## custom-cli 
- custom-cli folder location : [custom-cli](https://dev.azure.com/msazuredev/AzureForOperatorsIndustry/_git/afoi-nfa-api?path=/custom-cli) 
- This is the base folder where all our changes exist

# Important files and its usage
## _help.py
- Used to add the help text for the commands
- Example
    ```python
    helps['nf controller list'] = """
    type: command
    short-summary: "List details of Network Fabric Controllers for the given Resource group."
    examples:
      - name: List all Network Fabric Controllers by Resource Group.
        text: |-
            az nf controller list --resource-group "NFCResourceGroup" 
            az nf controller list -g "NFCResourceGroup"
      - name: List all Network Fabric Controllers by Subscription.
        text: |-
            az nf controller list --subscription "<subscriptionId>"
    """
    ```
## _params.py
- Used to add parameters under the commands
- Example
    ```python
    with loader.argument_context('nf controller create') as c:
        _arg(c, 'ipv4_address_space', 'Ipv4 address space used for NFC workload management. Example: 10.0.0.0/19 (Default).')
    ```
## commands.py
- Used to register new commands and subcommands (create, delete, list, show etc.,) under the particular command.
- Example
    ```python
    with loader.command_group(
            'nf controller',
            client_factory=cf.resource_client("networkfabriccontrollers")) as g:
        _add_common_commands(g, update=False)
    ```
## custom.py
- Used to map the new resource
- Example
    ```python
    model_map = {
        operations.networkfabriccontrollersOperations: models.networkfabriccontroller
    }
    ```

# Testing code changes locally
- Once you have fixed any issues in `../afoi-nfa-api/cli/{api-version}/src/ManagedNetworkFabric/azext_ManagedNetworkFabric/manual`, you can test it locally by using the below command
    ```
    make install-cli
    ```
- Note: It will package the changes into `python wheel` and install it. Once installed you can test the `az commands`

- If there are any swagger changes, update those changes in `../afoi-nfa-api/specification/managednetworkfabric/resource-manager/Microsoft.ManagedNetworkFabric/preview/{api-version}/{swagger-file}` and run the below commands
    ```
    make all
    make install-cli
    ```
- Note: It will generate the `CLI` and `SDK` for the swagger change and install the `python wheel`

# Commit changes to the repository
- Before commit to the branch, make sure you have copied the modified files from `../afoi-nfa-api/cli/<api-version>/src/ManagedNetworkFabric/azext_ManagedNetworkFabric/manual` to `../afoi-nfa-api/custom-cli`. 
- Run the below commands to generate the CLI for the changes.

    ```
    make generate-cli
    make install-cli
    ```
- Note: you need to commit both `manual` and `custom-cli` folder.

- If there are any swagger changes made, run the command
    ```
    make all
    ```
- Note: It will generate the `CLI` and `SDK` for the swagger changes.

# Test the wheel file after code merged
- step 1 : Download the latest *.whl file from [Latest wheel file](https://dev.azure.com/msazuredev/AzureForOperatorsIndustry/_artifacts/feed/ManagedNetworkFabricAzureCli)

- step 2 : Check whether `managednetworkfabric` extension is installed or not by using the below command
    ```
    az version
    ```

- step 3 : If `managednetworkfabric` already installed follow step 4 else step 5

- step 4 : Remove the existing `managednetworkfabric` and install the latest extension by using the below commands (when `managednetworkfabric` already installed)
    ```bash
    az extension remove -n managednetworkfabric
    az extension add --source <path_to_downloaded_artifact>/managednetworkfabric-*-py3-none-any.whl -y
    ```

- step 5 : Install the latest extension by using the command (when `managednetworkfabric` not already installed)
    ```
    az extension add --source <path_to_downloaded_artifact>/managednetworkfabric-*-py3-none-any.whl -y
    ```

- step 6 : Now the latest extension is installed. You can check whether it was properly installed or not by following the below step (step 2).
    ```
    az version
    ```

- step 7 : Refer [MANAGEDNETWORKFABRIC-CLI.md](https://dev.azure.com/msazuredev/AzureForOperatorsIndustry/_git/afoi-nfa?path=/documentation/rpaas/MANAGEDNETWORKFABRIC-CLI.md) to get the major commands for sanity testing.

# Support new api-version in managednetworkfabric cli
## Get latest swagger [GitHub](https://github.com/Azure/azure-rest-api-specs-pr/tree/RPSaaSMaster/specification/managednetworkfabric/resource-manager).
- step 1. Get the latest swagger and readme.md files available under the branch `RPSaaSMaster` from the above link.

- step 2. Update the api-version to which you need to generate the CLI in [MakeFile](https://dev.azure.com/msazuredev/AzureForOperatorsIndustry/_git/afoi-nfa-api?path=/Makefile).
    ```
    API_VERSION=<api-version>

    Eg: API_VERSION=2023-02-01-preview
    ```

- step 3. To generate CLI for the api-version "2023-02-01-preview", run the below command
    ```
    make generate-cli
    ```
- Note: It will generate the `CLI` with api-version "2023-02-01-preview" changes.

- step 4. To generate SDK for the api-version "2023-02-01-preview", run the below command
    ```
    make generate-sdk-go
    ```
- Note: It will generate the `go SDK` with api-version "2023-02-01-preview" changes.

- step 5. To install the CLI extension, run the below command
    ```
    make install-cli
    ```
- Note: It will package the generated CLI as a `python wheel` and install it in local.

# How to debug?
- You can add `--debug` at the end of the command to get the `debug log`
    ```bash
    # To get the debug log for the controller list command.
    az nf controller list -g "example-rg" --debug
    ```
# AzCLI Help Support
- We are supporting extensive help support for `az nf` commands
- You can suffix `-h` or `--help` to the command
    ```bash
    # To see list of commands available
    az nf --help

    # To see list of sub-commands available for controller
    az nf controller --help

    # To see list of parameters and examples available for particular sub-command
    az nf controller create --help
    ```


# Exposing *.whl file to customer
- Once the *.whl is tested completely, then you will expose the file to the customers.
- For now, the only way to expose is to upload the latest tested *.whl file to the [blob](https://nfadevstorage.blob.core.windows.net/mnfazcliwhl/)
- The owners who have write permissions to upload are [Kiranmayi Boyapati](mailto:kboyapati@microsoft.com) and [Marina Bashtovaya](mailto:mbashtovaya@microsoft.com)
